// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Practice {
  id           String   @id @default(uuid())
  name         String
  email        String?
  phone        String?
  address      String?
  slug         String?  @unique // For subdomain routing: {slug}.portal.getvantage.tech
  portalDomain String? // Custom domain mapping (optional)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users                    User[]
  patients                 Patient[]
  insurancePolicies        InsurancePolicy[]
  appointments             Appointment[]
  calIntegrations          CalIntegration[]
  calEventTypeMappings     CalEventTypeMapping[]
  retellIntegrations       RetellIntegration[]
  sendgridIntegrations     SendgridIntegration[]
  twilioIntegrations       TwilioIntegration[]
  ehrConnections           EhrConnection[]
  practiceSettings         PracticeSettings?
  integrationAuditLogs     IntegrationAuditLog[]
  voiceConversations       VoiceConversation[]
  workflows                Workflow[]
  auditLogs                AuditLog[]
  healixConversations      HealixConversation[]
  healixActionLogs         HealixActionLog[]
  patientNotes             PatientNote[]
  outboxEvents             OutboxEvent[]
  automationRules          AutomationRule[]
  automationRuns           AutomationRun[]
  brandProfile             BrandProfile?
  templates                MarketingTemplate[]
  templateVersions         MarketingTemplateVersion[]
  templateAssets           MarketingTemplateAsset[]
  contentBlocks            MarketingContentBlock[]
  marketingAuditLogs       MarketingAuditLog[]
  // Patient Portal
  patientAccounts          PatientAccount[]
  consentRecords           ConsentRecord[]
  communicationPreferences CommunicationPreference[]
  conversationThreads      ConversationThread[]
  portalMessages           PortalMessage[]
  portalTasks              PatientTask[]
  formTemplates            FormTemplate[]
  formRequests             FormRequest[]
  formSubmissions          FormSubmission[]
  documentUploads          DocumentUpload[]
  reviewRequests           ReviewRequest[]
  feedbacks                Feedback[]
  referralLinks            ReferralLink[]
  referralAttributions     ReferralAttribution[]
  portalAuditLogs          PortalAuditLog[]
  analyticsEvents          AnalyticsEvent[]
  campaigns                Campaign[]
  campaignEnrollments      CampaignEnrollment[]
  guardianRelationships    GuardianRelationship[]
  tasks                    Task[]
  taskComments             TaskComment[]
  teams                    Team[]
  communicationConversations CommunicationConversation[]
  communicationMessages      CommunicationMessage[]
  communicationAssignments   CommunicationAssignment[]
  communicationAttachments   CommunicationAttachment[]
  communicationTriggers      CommunicationTrigger[]
  knowledgeBaseArticles      KnowledgeBaseArticle[]
  knowledgeBaseChunks        KnowledgeBaseChunk[]
  knowledgeBaseFaqs          KnowledgeBaseFaq[]

  @@index([slug])
  @@index([portalDomain])
  @@map("practices")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String // 'vantage_admin', 'practice_admin', 'regular_user', 'admin', 'staff', 'provider' (legacy roles)
  practiceId   String? // Optional for vantage_admin users
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  practice                         Practice?                  @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  auditLogs                        AuditLog[]
  healixConversations              HealixConversation[]
  healixActionLogs                 HealixActionLog[]
  patientNotes                     PatientNote[]
  marketingTemplatesCreated        MarketingTemplate[]        @relation("MarketingTemplateCreator")
  marketingTemplateVersionsCreated MarketingTemplateVersion[] @relation("MarketingTemplateVersionCreator")
  marketingTemplateAssetsCreated   MarketingTemplateAsset[]   @relation("MarketingTemplateAssetCreator")
  marketingContentBlocksCreated    MarketingContentBlock[]    @relation("MarketingContentBlockCreator")
  marketingAuditLogs               MarketingAuditLog[]        @relation("MarketingAuditLogActor")
  assignedTasks                    Task[]                     @relation("AssignedTasks")
  createdTasks                     Task[]                     @relation("CreatedTasks")
  formTemplatesCreated             FormTemplate[]             @relation("FormTemplateCreator")
  formRequestsCreated              FormRequest[]              @relation("FormRequestCreator")
  taskComments                     TaskComment[]
  integrationAuditLogs             IntegrationAuditLog[]
  teamMemberships                  TeamMember[]
  communicationMessages            CommunicationMessage[]
  communicationAssignments         CommunicationAssignment[] @relation("CommunicationAssignmentUser")
  communicationAssignmentActions   CommunicationAssignment[] @relation("CommunicationAssignmentActor")

  @@index([practiceId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Patient {
  id                      String    @id @default(uuid())
  practiceId              String
  name                    String // Legacy field - kept for backward compatibility
  // Basic Information
  externalEhrId           String?
  firstName               String?
  lastName                String?
  preferredName           String?
  dateOfBirth             DateTime?
  // Contact Information
  primaryPhone            String?
  secondaryPhone          String?
  phone                   String // Legacy field - kept for backward compatibility
  email                   String?
  addressLine1            String?
  addressLine2            String?
  address                 String? // Legacy field - kept for backward compatibility
  city                    String?
  state                   String?
  postalCode              String?
  gender                  String? // 'male', 'female', 'other', 'unknown'
  pronouns                String? // 'he/him', 'she/her', 'they/them', 'custom'
  primaryLanguage         String?
  // Communication Preferences & Consent
  preferredContactMethod  String // 'phone', 'email', 'sms' - legacy, use preferredChannel
  preferredChannel        String? // 'sms', 'email', 'voice'
  smsOptIn                Boolean   @default(false)
  smsOptInAt              DateTime?
  emailOptIn              Boolean   @default(false)
  voiceOptIn              Boolean   @default(false)
  doNotContact            Boolean   @default(false)
  quietHoursStart         String? // Time format: 'HH:mm'
  quietHoursEnd           String? // Time format: 'HH:mm'
  consentSource           String? // 'web', 'voice', 'staff', 'import'
  // Insurance Summary
  primaryInsuranceId      String?
  secondaryInsuranceId    String?
  insuranceStatus         String? // 'verified', 'missing', 'expired', 'self_pay'
  lastInsuranceVerifiedAt DateTime?
  selfPay                 Boolean   @default(false)
  // Legacy fields
  notes                   String?
  deletedAt               DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  practice                 Practice                  @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  insurancePolicies        InsurancePolicy[]
  appointments             Appointment[]
  voiceConversations       VoiceConversation[]
  tags                     PatientTag[]
  timelineEntries          PatientTimelineEntry[]
  patientNotes             PatientNote[]
  // Patient Portal
  patientAccount           PatientAccount?
  guardianships            GuardianRelationship[]    @relation("Guardian")
  dependents               GuardianRelationship[]    @relation("Dependent")
  consentRecords           ConsentRecord[]
  communicationPreferences CommunicationPreference[]
  conversationThreads      ConversationThread[]
  portalMessages           PortalMessage[]
  portalTasks              PatientTask[]
  formRequests             FormRequest[]
  tasks                    Task[]
  communicationConversations CommunicationConversation[]
  communicationMessages      CommunicationMessage[]
  formSubmissions          FormSubmission[]
  documentUploads          DocumentUpload[]
  reviewRequests           ReviewRequest[]
  feedbacks                Feedback[]
  referralAttributions     ReferralAttribution[]
  campaignEnrollments      CampaignEnrollment[]

  @@index([practiceId])
  @@index([phone])
  @@index([email])
  @@index([deletedAt])
  @@index([externalEhrId])
  @@index([primaryInsuranceId])
  @@index([secondaryInsuranceId])
  @@map("patients")
}

model PatientNote {
  id         String    @id @default(uuid())
  patientId  String
  practiceId String
  userId     String
  type       String // 'general', 'medical', 'administrative', 'billing', 'appointment', 'medication', 'allergy', 'contact', 'insurance', 'other'
  content    String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([practiceId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("patient_notes")
}

model PatientTag {
  id        String   @id @default(uuid())
  patientId String
  tag       String
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, tag])
  @@index([patientId])
  @@map("patient_tags")
}

model PatientTimelineEntry {
  id          String   @id @default(uuid())
  patientId   String
  type        String // 'appointment', 'insurance', 'call', 'note', 'email', 'field_update', 'document', 'payment', 'reminder', 'task', 'other'
  title       String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, createdAt])
  @@map("patient_timeline_entries")
}

model InsurancePolicy {
  id                    String    @id @default(uuid())
  practiceId            String
  patientId             String
  payerNameRaw          String    // Payer name (required)
  insurerPhoneRaw       String?   // Carrier phone as entered by staff/agent
  insurerPhoneNormalized String?  // E.164-like normalized number for dialing
  memberId              String    // Member ID / Policy # (required)
  groupNumber           String?   // Group # (optional)
  planName              String?   // Plan name (optional)
  planType              String?   // PPO, HMO, EPO, POS, Medicare, Medicaid, Other, Unknown
  isPrimary             Boolean   @default(true)
  subscriberIsPatient    Boolean   @default(true)
  subscriberFirstName    String?
  subscriberLastName    String?
  subscriberDob         DateTime?
  relationshipToPatient String?   // Spouse, Child, Other
  bcbsAlphaPrefix       String?   // BCBS routing: alpha prefix
  bcbsStatePlan         String?   // e.g. "BCBS of Texas"
  rxBin                 String?
  rxPcn                 String?
  rxGroup               String?
  cardFrontRef          String?   // Blob storage ref/URL only
  cardBackRef           String?   // Blob storage ref/URL only
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([patientId])
  @@index([memberId])
  @@map("insurance_policies")
}

model Appointment {
  id           String   @id @default(uuid())
  practiceId   String
  patientId    String
  providerId   String? // For future provider assignment
  status       String // 'scheduled', 'confirmed', 'completed', 'cancelled', 'no_show'
  startTime    DateTime
  endTime      DateTime
  timezone     String
  visitType    String // Maps to Cal event type name
  reason       String?
  notes        String?
  calEventId   String? // Cal.com event type ID
  calBookingId String?  @unique // Cal.com booking ID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([patientId])
  @@index([startTime])
  @@index([status])
  @@index([calBookingId])
  @@map("appointments")
}

model CalIntegration {
  id                String   @id @default(uuid())
  practiceId        String   @unique
  apiKey            String // Encrypted in production
  calOrganizationId String?
  calTeamId         String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  practice          Practice              @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  eventTypeMappings CalEventTypeMapping[]

  @@index([practiceId])
  @@map("cal_integrations")
}

model CalEventTypeMapping {
  id               String   @id @default(uuid())
  practiceId       String
  calIntegrationId String
  visitTypeName    String // e.g., "Consultation", "Follow-up"
  calEventTypeId   String // Cal.com event type ID
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  practice       Practice       @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  calIntegration CalIntegration @relation(fields: [calIntegrationId], references: [id], onDelete: Cascade)

  @@unique([practiceId, visitTypeName])
  @@index([practiceId])
  @@index([calEventTypeId])
  @@map("cal_event_type_mappings")
}

model RetellIntegration {
  id                 String   @id @default(uuid())
  practiceId         String   @unique
  apiKey             String // Encrypted in production
  agentId            String? // Optional: default agent ID for this practice
  insuranceVerificationAgentId String? // Agent ID dedicated to insurance verification outbound calls
  mcpBaseUrl         String? // Base MCP endpoint used for outbound tool calls
  mcpApiKey          String? // Optional header-based auth for MCP
  mcpActorId         String? // Optional actor id for MCP calls
  mcpRequestIdPrefix String? // Optional request id prefix for observability
  outboundToolName   String? // Optional outbound tool name (defaults to create_outbound_call)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@map("retell_integrations")
}

model SendgridIntegration {
  id         String   @id @default(uuid())
  practiceId String   @unique
  apiKey     String // Encrypted in production
  fromEmail  String // Default "from" email address
  fromName   String? // Optional: Default "from" name
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@map("sendgrid_integrations")
}

model TwilioIntegration {
  id                  String   @id @default(uuid())
  practiceId          String   @unique
  accountSid          String
  authToken           String
  messagingServiceSid String?
  fromNumber          String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@map("twilio_integrations")
}

model PracticeSettings {
  id         String   @id @default(uuid())
  practiceId String   @unique
  smartFhir  Json?
  ehrIntegrations Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@map("practice_settings")
}

model EhrConnection {
  id                    String   @id @default(uuid())
  tenantId              String
  providerId            String
  status                String   @default("connected")
  issuer                String
  fhirBaseUrl           String
  authorizationEndpoint String?
  tokenEndpoint         String?
  revocationEndpoint    String?
  clientId              String
  clientSecretEnc       String?
  scopesRequested       String?
  scopesGranted         String?
  accessTokenEnc        String?
  refreshTokenEnc       String?
  expiresAt             DateTime?
  idTokenClaimsSummary  Json?
  vendorConfig          Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  practice Practice @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  facilityMaps EhrFacilityMap[]

  @@unique([tenantId, providerId, issuer])
  @@index([tenantId])
  @@index([providerId])
  @@index([status])
  @@map("ehr_connections")
}

model EhrFacilityMap {
  id               String   @id @default(uuid())
  connectionId     String
  externalFacilityId String
  name             String?
  status           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  connection EhrConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([externalFacilityId])
  @@map("ehr_facility_maps")
}

model IntegrationAuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  actorUserId String?
  action      String
  entity      String
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  practice Practice @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor    User?    @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, entity, entityId])
  @@index([createdAt])
  @@map("integration_audit_logs")
}

model VoiceConversation {
  id              String    @id @default(uuid())
  practiceId      String
  patientId       String?
  callerPhone     String
  retellCallId    String?
  startedAt       DateTime
  endedAt         DateTime?
  transcript      String? // Redacted PHI
  extractedIntent String?
  outcome         String? // 'appointment_booked', 'information_only', 'failed', etc.
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  @@index([practiceId])
  @@index([patientId])
  @@index([callerPhone])
  @@index([startedAt])
  @@map("voice_conversations")
}

model Workflow {
  id            String    @id @default(uuid())
  practiceId    String
  name          String
  description   String?
  isActive      Boolean   @default(false)
  triggerType   String? // e.g., 'record_command', 'appointment_created'
  triggerConfig Json? // JSON configuration for trigger
  publishedAt   DateTime? @map("published_at") // When the workflow was last published
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  practice Practice       @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  steps    WorkflowStep[]
  runs     WorkflowRun[]

  @@index([practiceId])
  @@index([isActive])
  @@map("workflows")
}

model WorkflowStep {
  id         String   @id @default(uuid())
  workflowId String
  type       String // 'condition', 'action'
  order      Int // Position in workflow sequence
  config     Json // JSON configuration for the step
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([workflowId, order])
  @@map("workflow_steps")
}

model WorkflowRun {
  id          String    @id @default(uuid())
  workflowId  String
  status      String // 'success', 'failed', 'running'
  triggerData Json? // Data that triggered the workflow
  result      Json? // Result/output of the workflow execution
  error       String?
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([startedAt])
  @@map("workflow_runs")
}

model AuditLog {
  id           String   @id @default(uuid())
  practiceId   String
  userId       String
  action       String // 'create', 'update', 'delete', 'view'
  resourceType String // 'patient', 'appointment', 'insurance', etc.
  resourceId   String
  changes      Json? // Before/after state (redacted)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([practiceId, resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// MCP server: audit every tool call (PHI access)
model McpAccessAuditLog {
  id                 String   @id @default(uuid())
  requestId          String   // X-Request-Id
  actorId            String
  actorType          String   // 'agent' | 'user' | 'system'
  purpose            String   // must be insurance_verification
  patientId          String?
  policyId           String?
  toolName           String
  fieldsReturnedJson Json?    // array of field paths, NOT values
  createdAt          DateTime @default(now())

  @@index([requestId])
  @@index([actorId, createdAt])
  @@index([patientId, createdAt])
  @@map("mcp_access_audit_logs")
}

model HealixConversation {
  id         String   @id @default(uuid())
  practiceId String // Multi-tenant: scoped to practice
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  practice   Practice          @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages   HealixMessage[]
  actionLogs HealixActionLog[]

  @@index([practiceId])
  @@index([userId])
  @@index([updatedAt])
  @@map("healix_conversations")
}

model HealixMessage {
  id             String   @id @default(uuid())
  conversationId String
  role           String // 'user', 'assistant', 'tool'
  content        Json // Store message content as JSON to handle markdown, structured data, etc.
  createdAt      DateTime @default(now())

  conversation HealixConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("healix_messages")
}

model HealixActionLog {
  id             String   @id @default(uuid())
  conversationId String?
  userId         String
  practiceId     String // Multi-tenant: scoped to practice
  actionType     String // e.g., 'tool_call', 'action_executed'
  toolName       String? // Name of the tool that was called
  toolArgs       Json? // Arguments passed to the tool
  toolResult     Json? // Result returned from the tool
  createdAt      DateTime @default(now())

  practice     Practice            @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation HealixConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([practiceId])
  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("healix_action_logs")
}

model OutboxEvent {
  id            String    @id @default(uuid())
  practiceId    String
  name          String // e.g., "crm/appointment.created"
  payload       Json
  status        String // 'pending', 'published', 'failed'
  attempts      Int       @default(0)
  nextAttemptAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([status])
  @@index([status, nextAttemptAt])
  @@index([name])
  @@map("outbox_events")
}

model AutomationRule {
  id              String   @id @default(uuid())
  practiceId      String
  name            String
  enabled         Boolean  @default(true)
  triggerEvent    String // Same namespace as OutboxEvent.name
  conditionsJson  Json // v1: JSONLogic or CEL-like subset; store as JSON
  actionsJson     Json // List of actions with params
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  practice Practice        @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  runs     AutomationRun[]

  @@index([practiceId])
  @@index([practiceId, enabled])
  @@index([practiceId, triggerEvent])
  @@index([enabled])
  @@map("automation_rules")
}

model AutomationRun {
  id            String    @id @default(uuid())
  practiceId    String
  ruleId        String
  sourceEventId String // OutboxEvent.id
  status        String // 'running', 'succeeded', 'failed', 'skipped'
  startedAt     DateTime  @default(now())
  finishedAt    DateTime?
  error         String?
  result        Json? // Summary of execution

  practice   Practice              @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  rule       AutomationRule        @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  actionLogs AutomationActionLog[]

  @@index([practiceId])
  @@index([ruleId])
  @@index([sourceEventId])
  @@index([status])
  @@index([startedAt])
  @@map("automation_runs")
}

model AutomationActionLog {
  id           String   @id @default(uuid())
  runId        String
  practiceId   String
  actionType   String // 'send_sms' | 'send_email' | 'create_task' | 'create_note' | 'update_patient_fields'
  actionArgs   Json
  actionResult Json?
  status       String // 'succeeded', 'failed', 'skipped'
  error        String?
  createdAt    DateTime @default(now())

  run AutomationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([practiceId])
  @@index([actionType])
  @@index([status])
  @@index([createdAt])
  @@map("automation_action_logs")
}

// Marketing Module Models

model BrandProfile {
  id                  String   @id @default(uuid())
  tenantId            String   @unique // practiceId, using tenantId for clarity in marketing context
  practiceName        String
  logoUrl             String?
  primaryColor        String   @default("#2563eb")
  secondaryColor      String?
  fontFamily          String   @default("Arial") // Enum: Arial, Helvetica, Georgia, Times New Roman, Courier New
  headerLayout        String   @default("left") // Enum: left, center
  emailFooterHtml     String?
  smsFooterText       String? // e.g., "Reply STOP to opt out"
  defaultFromName     String
  defaultFromEmail    String
  defaultReplyToEmail String?
  defaultSmsSenderId  String? // Could be Twilio numberId later; for now string
  quietHoursStart     String   @default("09:00") // Time format: HH:mm
  quietHoursEnd       String   @default("17:00") // Time format: HH:mm
  timezone            String   @default("America/Chicago")
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())

  practice Practice @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("brand_profiles")
}

model MarketingTemplate {
  id               String    @id @default(uuid())
  tenantId         String // practiceId
  channel          String // Enum: email, sms
  name             String
  category         String // Enum: reminder, confirmation, reactivation, followup, reviews, broadcast, custom
  status           String    @default("draft") // Enum: draft, published, archived
  editorType       String    @default("dragdrop") // Enum: dragdrop, html, plaintext (sms uses plaintext)
  subject          String? // Email only
  preheader        String? // Email only
  bodyJson         Json? // Dragdrop structure for email builder
  bodyHtml         String? // Stored HTML if HTML editor OR generated output snapshot
  bodyText         String? // SMS body
  variablesUsed    Json? // List of variable keys used: ["patient.firstName", "appointment.date", etc.]
  complianceConfig Json? // Flags/settings for injection behavior
  lastPublishedAt  DateTime?
  createdByUserId  String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  practice  Practice                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  versions  MarketingTemplateVersion[]
  createdBy User                       @relation("MarketingTemplateCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, channel])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@index([createdByUserId])
  @@map("marketing_templates")
}

model MarketingTemplateVersion {
  id              String   @id @default(uuid())
  templateId      String
  tenantId        String
  versionNumber   Int
  snapshot        Json // Full template snapshot (all fields needed to render)
  createdByUserId String
  createdAt       DateTime @default(now())

  template  MarketingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  practice  Practice          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User              @relation("MarketingTemplateVersionCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([tenantId])
  @@index([templateId, versionNumber])
  @@map("marketing_template_versions")
}

model MarketingTemplateAsset {
  id              String   @id @default(uuid())
  tenantId        String
  type            String // Enum: image, file
  url             String
  meta            Json? // width/height/alt, etc.
  createdByUserId String
  createdAt       DateTime @default(now())

  practice  Practice @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User     @relation("MarketingTemplateAssetCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdByUserId])
  @@map("marketing_template_assets")
}

model MarketingContentBlock {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  description     String?
  blockData       Json // The block or row structure (can be a single block or a full row)
  blockType       String // 'block' or 'row' - indicates if this is a reusable block or a full row/section
  category        String? // 'header', 'footer', 'cta', 'product', 'custom', etc.
  tags            Json? // Array of tags for filtering
  isGlobal        Boolean  @default(false) // If true, updates propagate to all templates using it
  usageCount      Int      @default(0) // Track how many templates use this block
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  practice  Practice @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User     @relation("MarketingContentBlockCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isGlobal])
  @@index([createdByUserId])
  @@map("marketing_content_blocks")
}

model MarketingAuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  actorUserId String? // Null for system actions
  actorType   String // Enum: staff, agent, system
  action      String // e.g., TEMPLATE_CREATED, TEMPLATE_PUBLISHED, BRAND_UPDATED, TEST_SENT
  entityType  String // Template, BrandProfile, etc.
  entityId    String
  metadata    Json? // Additional context
  createdAt   DateTime @default(now())

  practice Practice @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor    User?    @relation("MarketingAuditLogActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
  @@index([createdAt])
  @@map("marketing_audit_logs")
}

// ========================================
// PATIENT PORTAL MODELS
// ========================================

model PatientAccount {
  id                   String    @id @default(uuid())
  practiceId           String
  patientId            String    @unique
  email                String?
  phone                String?
  emailVerified        Boolean   @default(false)
  phoneVerified        Boolean   @default(false)
  otpCode              String?
  otpExpiresAt         DateTime?
  otpAttempts          Int       @default(0)
  lastLoginAt          DateTime?
  inviteToken          String?   @unique
  inviteTokenExpiresAt DateTime?
  passwordHash         String? // For password-based auth (optional)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([practiceId, patientId])
  @@index([email])
  @@index([phone])
  @@index([inviteToken])
  @@map("patient_accounts")
}

model GuardianRelationship {
  id           String   @id @default(uuid())
  practiceId   String
  guardianId   String
  dependentId  String
  relationship String // 'parent', 'guardian', 'spouse', 'other'
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  practice  Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  guardian  Patient  @relation("Guardian", fields: [guardianId], references: [id], onDelete: Cascade)
  dependent Patient  @relation("Dependent", fields: [dependentId], references: [id], onDelete: Cascade)

  @@unique([guardianId, dependentId])
  @@index([practiceId])
  @@index([guardianId])
  @@index([dependentId])
  @@map("guardian_relationships")
}

model ConsentRecord {
  id          String    @id @default(uuid())
  practiceId  String
  patientId   String
  consentType String // 'marketing', 'sms', 'email', 'portal', 'data_sharing'
  consented   Boolean
  method      String // 'web', 'sms', 'voice', 'staff', 'import'
  source      String? // IP address, phone number, etc.
  metadata    Json?
  expiresAt   DateTime?
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId, patientId])
  @@index([practiceId, createdAt])
  @@index([consentType])
  @@map("consent_records")
}

model CommunicationPreference {
  id               String   @id @default(uuid())
  practiceId       String
  patientId        String   @unique
  preferredChannel String   @default("email") // 'sms', 'email', 'voice', 'portal'
  smsEnabled       Boolean  @default(true)
  emailEnabled     Boolean  @default(true)
  voiceEnabled     Boolean  @default(false)
  portalEnabled    Boolean  @default(true)
  quietHoursStart  String? // 'HH:mm'
  quietHoursEnd    String? // 'HH:mm'
  frequencyCap     Int? // Max messages per day/week
  frequencyPeriod  String? // 'day', 'week'
  unsubscribeToken String?  @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId, patientId])
  @@index([unsubscribeToken])
  @@map("communication_preferences")
}

model ConversationThread {
  id            String    @id @default(uuid())
  practiceId    String
  patientId     String
  subject       String?
  status        String    @default("open") // 'open', 'closed', 'archived'
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  practice Practice        @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages PortalMessage[]

  @@index([practiceId, patientId])
  @@index([practiceId, lastMessageAt])
  @@index([status])
  @@map("conversation_threads")
}

// ========================================
// COMMUNICATIONS MODULE MODELS
// ========================================

model Team {
  id          String   @id @default(uuid())
  practiceId  String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  practice    Practice       @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  assignments CommunicationAssignment[]

  @@unique([practiceId, name])
  @@index([practiceId])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  role      String?
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model CommunicationConversation {
  id                 String   @id @default(uuid())
  practiceId         String
  patientId          String
  channel            String // 'sms', 'secure', 'voice', 'video'
  status             String   @default("open") // 'open', 'pending', 'resolved'
  subject            String?
  lastMessageAt      DateTime?
  lastMessagePreview String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  practice   Practice                     @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient    Patient                      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages   CommunicationMessage[]
  assignments CommunicationAssignment[]
  summary    CommunicationConversationSummary?
  draftReply CommunicationDraftReply?

  @@index([practiceId])
  @@index([practiceId, status])
  @@index([practiceId, channel])
  @@index([practiceId, lastMessageAt])
  @@index([patientId])
  @@map("communication_conversations")
}

model CommunicationDraftReply {
  id             String   @id @default(uuid())
  conversationId String   @unique
  draftText      String
  citations      Json
  confidence     String // 'low', 'medium', 'high'
  createdAt      DateTime @default(now())
  lastModifiedAt DateTime @updatedAt

  conversation CommunicationConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("communication_draft_replies")
}

model CommunicationConversationSummary {
  id               String   @id @default(uuid())
  conversationId   String   @unique
  whatHappened     String
  latestPatientAsk String
  actionsTaken     String
  confidence       String // 'low', 'medium', 'high'
  lastGeneratedAt  DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  conversation CommunicationConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([lastGeneratedAt])
  @@map("communication_conversation_summaries")
}

model CommunicationMessage {
  id               String    @id @default(uuid())
  practiceId       String
  conversationId   String
  patientId        String
  authorUserId     String?
  direction        String // 'inbound', 'outbound', 'internal'
  type             String // 'message', 'note', 'system'
  body             String
  channel          String // 'sms', 'secure', 'voice', 'video'
  deliveryStatus   String   @default("queued") // 'queued', 'sent', 'delivered', 'failed'
  metadata         Json?
  intent           String?
  intentConfidence Float?
  readAt           DateTime?
  createdAt        DateTime @default(now())

  practice     Practice                  @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  conversation CommunicationConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  patient      Patient                   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  author       User?                     @relation(fields: [authorUserId], references: [id], onDelete: SetNull)
  attachments  CommunicationAttachment[]

  @@index([practiceId])
  @@index([conversationId])
  @@index([patientId])
  @@index([authorUserId])
  @@index([createdAt])
  @@index([deliveryStatus])
  @@map("communication_messages")
}

model CommunicationAssignment {
  id               String   @id @default(uuid())
  practiceId       String
  conversationId   String
  assignedUserId   String?
  assignedTeamId   String?
  status           String   @default("active") // 'active', 'pending', 'resolved'
  assignedByUserId String?
  assignedAt       DateTime @default(now())
  updatedAt        DateTime @updatedAt

  practice     Practice                  @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  conversation CommunicationConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  assignedUser User?                     @relation("CommunicationAssignmentUser", fields: [assignedUserId], references: [id], onDelete: SetNull)
  assignedTeam Team?                     @relation(fields: [assignedTeamId], references: [id], onDelete: SetNull)
  assignedBy   User?                     @relation("CommunicationAssignmentActor", fields: [assignedByUserId], references: [id], onDelete: SetNull)

  @@index([practiceId])
  @@index([conversationId])
  @@index([assignedUserId])
  @@index([assignedTeamId])
  @@index([status])
  @@map("communication_assignments")
}

model CommunicationAttachment {
  id         String   @id @default(uuid())
  practiceId String
  messageId  String
  fileName   String
  mimeType   String?
  fileSize   Int?
  storageKey String
  url        String?
  createdAt  DateTime @default(now())

  practice Practice             @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  message  CommunicationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([messageId])
  @@map("communication_attachments")
}

model CommunicationTrigger {
  id             String   @id @default(uuid())
  practiceId     String
  name           String
  eventType      String
  conditionsJson Json
  actionsJson    Json
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([practiceId, eventType])
  @@index([enabled])
  @@map("communication_triggers")
}

model KnowledgeBaseArticle {
  id         String   @id @default(uuid())
  practiceId String
  title      String
  body       String
  summary    String?
  lastSummarizedAt DateTime?
  url        String?
  tags       String[]
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  chunks   KnowledgeBaseChunk[]
  faqs     KnowledgeBaseFaq[]

  @@index([practiceId])
  @@index([isActive])
  @@index([updatedAt])
  @@map("knowledge_base_articles")
}

model KnowledgeBaseChunk {
  id         String   @id @default(uuid())
  practiceId String
  articleId  String
  content    String
  summary    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  article  KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([articleId])
  @@map("knowledge_base_chunks")
}

model KnowledgeBaseFaq {
  id         String   @id @default(uuid())
  practiceId String
  articleId  String
  question   String
  answer     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  article  KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([articleId])
  @@map("knowledge_base_faqs")
}

model PortalMessage {
  id         String    @id @default(uuid())
  practiceId String
  patientId  String
  threadId   String?
  channel    String // 'PORTAL', 'SMS', 'EMAIL', 'VOICE'
  direction  String // 'inbound', 'outbound'
  subject    String?
  body       String // For PORTAL, may include PHI
  bodyHtml   String? // For EMAIL
  metadata   Json? // Channel-specific data (Twilio SID, SendGrid ID, etc.)
  status     String    @default("sent") // 'sent', 'delivered', 'read', 'failed'
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  practice Practice            @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  thread   ConversationThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)

  @@index([practiceId, patientId])
  @@index([practiceId, createdAt])
  @@index([threadId])
  @@index([channel, status])
  @@map("portal_messages")
}

model PatientTask {
  id          String    @id @default(uuid())
  practiceId  String
  patientId   String
  type        String // 'intake', 'document_upload', 'form_completion', 'payment', 'other'
  title       String
  description String?
  status      String    @default("pending") // 'pending', 'in_progress', 'completed', 'cancelled'
  dueDate     DateTime?
  completedAt DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId, patientId])
  @@index([practiceId, status])
  @@index([practiceId, dueDate])
  @@map("patient_tasks")
}

model FormTemplate {
  id              String   @id @default(uuid())
  practiceId      String
  name            String
  description     String?
  category        String // 'intake', 'consent', 'medical_history', 'custom'
  status          String   @default("published") // 'draft', 'published', 'archived'
  schema          Json // Field definitions
  isSystem        Boolean  @default(false)
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  practice   Practice        @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  createdBy  User            @relation("FormTemplateCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  requests   FormRequest[]
  submissions FormSubmission[]

  @@index([practiceId])
  @@index([practiceId, status])
  @@index([practiceId, category])
  @@index([isSystem])
  @@map("form_templates")
}

model FormRequest {
  id              String    @id @default(uuid())
  practiceId      String
  patientId       String
  formTemplateId  String
  status          String    @default("pending") // 'pending', 'in_progress', 'submitted', 'expired', 'cancelled'
  dueDate         DateTime?
  sentAt          DateTime  @default(now())
  completedAt     DateTime?
  metadata        Json?
  createdByUserId String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  practice    Practice     @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  template    FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  createdBy   User         @relation("FormRequestCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  submission  FormSubmission?

  @@index([practiceId])
  @@index([practiceId, patientId])
  @@index([practiceId, status])
  @@index([formTemplateId])
  @@map("form_requests")
}

model FormSubmission {
  id          String    @id @default(uuid())
  practiceId  String
  patientId   String
  formTemplateId String?
  formRequestId  String?
  formType    String // 'intake', 'consent', 'registration', 'other'
  formData    Json // Structured form response
  status      String    @default("submitted") // 'submitted', 'reviewed', 'approved'
  submittedAt DateTime  @default(now())
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  practice Practice      @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  template FormTemplate? @relation(fields: [formTemplateId], references: [id], onDelete: SetNull)
  request  FormRequest?  @relation(fields: [formRequestId], references: [id], onDelete: SetNull)

  @@index([practiceId, patientId])
  @@index([practiceId, submittedAt])
  @@index([formType])
  @@index([formTemplateId])
  @@index([formRequestId])
  @@unique([formRequestId])
  @@map("form_submissions")
}

model DocumentUpload {
  id         String    @id @default(uuid())
  practiceId String
  patientId  String
  taskId     String? // Optional link to PatientTask
  fileName   String
  fileUrl    String
  fileType   String? // MIME type
  fileSize   Int? // Bytes
  category   String? // 'insurance', 'id', 'medical_record', 'other'
  status     String    @default("uploaded") // 'uploaded', 'reviewed', 'approved', 'rejected'
  uploadedAt DateTime  @default(now())
  reviewedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([practiceId, patientId])
  @@index([practiceId, uploadedAt])
  @@index([category])
  @@map("document_uploads")
}

model ReviewRequest {
  id            String    @id @default(uuid())
  practiceId    String
  patientId     String
  appointmentId String?
  requestedAt   DateTime  @default(now())
  sentAt        DateTime?
  completedAt   DateTime?
  channel       String? // 'email', 'sms', 'portal'
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  practice  Practice   @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient   Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  feedbacks Feedback[]

  @@index([practiceId, patientId])
  @@index([practiceId, requestedAt])
  @@map("review_requests")
}

model Feedback {
  id              String    @id @default(uuid())
  practiceId      String
  patientId       String
  reviewRequestId String?
  type            String // 'nps', 'csat', 'review'
  score           Int? // NPS: 0-10, CSAT: 1-5
  comment         String?
  isPublic        Boolean   @default(false) // For public review sites
  isResolved      Boolean   @default(false)
  resolvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  practice      Practice       @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  reviewRequest ReviewRequest? @relation(fields: [reviewRequestId], references: [id], onDelete: SetNull)

  @@index([practiceId, patientId])
  @@index([practiceId, createdAt])
  @@index([type])
  @@map("feedback")
}

model ReferralLink {
  id         String    @id @default(uuid())
  practiceId String
  code       String    @unique
  name       String?
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  practice     Practice              @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  attributions ReferralAttribution[]

  @@index([practiceId])
  @@index([code])
  @@map("referral_links")
}

model ReferralAttribution {
  id                  String   @id @default(uuid())
  practiceId          String
  patientId           String
  referralLinkId      String
  referredByPatientId String? // If another patient referred them
  source              String? // 'link', 'patient_referral'
  createdAt           DateTime @default(now())

  practice     Practice     @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  referralLink ReferralLink @relation(fields: [referralLinkId], references: [id], onDelete: Cascade)

  @@index([practiceId, patientId])
  @@index([referralLinkId])
  @@map("referral_attributions")
}

model Campaign {
  id          String   @id @default(uuid())
  practiceId  String
  name        String
  description String?
  type        String // 'welcome', 'reactivation', 'educational', 'promotional', 'custom'
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  practice    Practice             @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  enrollments CampaignEnrollment[]

  @@index([practiceId])
  @@index([practiceId, isActive])
  @@map("campaigns")
}

model CampaignEnrollment {
  id             String          @id @default(uuid())
  practiceId     String
  patientId      String
  campaignId     String
  enrolledAt     DateTime        @default(now())
  status         String          @default("active") // 'active', 'paused', 'completed', 'unsubscribed'
  unsubscribedAt DateTime?
  events         CampaignEvent[]

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient  Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([patientId, campaignId])
  @@index([practiceId, patientId])
  @@index([campaignId])
  @@index([status])
  @@map("campaign_enrollments")
}

model CampaignEvent {
  id           String   @id @default(uuid())
  enrollmentId String
  eventType    String // 'sent', 'delivered', 'opened', 'clicked', 'bounced', 'failed'
  eventData    Json?
  occurredAt   DateTime @default(now())

  enrollment CampaignEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([occurredAt])
  @@map("campaign_events")
}

model PortalAuditLog {
  id           String   @id @default(uuid())
  practiceId   String
  patientId    String?
  action       String // 'consent_changed', 'preference_updated', 'message_sent', 'task_completed', etc.
  resourceType String?
  resourceId   String?
  changes      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([practiceId, patientId])
  @@index([practiceId, createdAt])
  @@index([action])
  @@map("portal_audit_logs")
}

model AnalyticsEvent {
  id         String   @id @default(uuid())
  practiceId String
  patientId  String?
  eventType  String // 'page_view', 'action', 'conversion'
  eventName  String
  properties Json?
  sessionId  String?
  createdAt  DateTime @default(now())

  practice Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@index([practiceId, patientId])
  @@index([practiceId, createdAt])
  @@index([eventType, eventName])
  @@map("analytics_events")
}

// Comprehensive Task Management System
model Task {
  id             String    @id @default(uuid())
  practiceId     String
  // Task assignment and ownership
  assignedTo     String? // User ID - null means unassigned (general/anyone can execute)
  createdBy      String // User ID who created the task
  // Task context
  patientId      String? // null for personal tasks, set for patient-related tasks
  appointmentId  String? // Optional link to appointment
  // Task details
  title          String
  description    String?
  category       String    @default("general") // 'general', 'follow_up', 'document_review', 'billing', 'appointment_prep', 'insurance', 'administrative', 'clinical', 'other'
  priority       String    @default("medium") // 'low', 'medium', 'high', 'urgent'
  status         String    @default("pending") // 'pending', 'in_progress', 'completed', 'cancelled', 'on_hold'
  // Dates
  dueDate        DateTime?
  completedAt    DateTime?
  // Task metadata
  metadata       Json? // Additional structured data
  // Recurring tasks
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // e.g., "daily", "weekly", "monthly", cron expression
  parentTaskId   String? // For recurring task series
  // Task relationships
  relatedTaskIds String[] // Array of related task IDs
  // Timestamps
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  practice   Practice      @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  patient    Patient?      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  assignee   User?         @relation("AssignedTasks", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator    User          @relation("CreatedTasks", fields: [createdBy], references: [id], onDelete: Cascade)
  comments   TaskComment[]
  parentTask Task?         @relation("RecurringTasks", fields: [parentTaskId], references: [id], onDelete: SetNull)
  childTasks Task[]        @relation("RecurringTasks")

  @@index([practiceId])
  @@index([practiceId, assignedTo])
  @@index([practiceId, patientId])
  @@index([practiceId, status])
  @@index([practiceId, dueDate])
  @@index([practiceId, createdBy])
  @@index([assignedTo])
  @@index([patientId])
  @@index([status, dueDate])
  @@index([deletedAt])
  @@map("tasks")
}

model TaskComment {
  id        String    @id @default(uuid())
  taskId    String
  userId    String
  practiceId String?
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  practice  Practice? @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([practiceId])
  @@index([createdAt])
  @@map("task_comments")
}
